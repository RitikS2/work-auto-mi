<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Processing File...</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .spinner-border {
      width: 4rem;
      height: 4rem;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container text-center py-5">
    <h2 class="mb-4">üîÑ Processing Your File...</h2>

    <div id="loader" class="spinner-border text-primary mb-4" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="text-muted">This may take a few seconds depending on file size and number of months selected.</p>

    <div id="result" class="mt-4"></div>
  </div>

  <script>
    const taskId = new URLSearchParams(window.location.search).get("task_id");

    async function checkStatus() {
      try {
        const response = await fetch(`/status?task_id=${taskId}`);
        const data = await response.json();

        if (data.status === "done") {
          document.getElementById("loader").classList.add("d-none");
          document.getElementById("result").innerHTML = `
            <div class="alert alert-success" role="alert">‚úÖ File processed successfully!</div>
            <a href="${data.download_url}" class="btn btn-success">Download Processed File</a>
          `;
        } else if (data.status === "error") {
          document.getElementById("loader").classList.add("d-none");
          document.getElementById("result").innerHTML = `
            <div class="alert alert-danger" role="alert">‚ö†Ô∏è ${data.error}</div>
          `;
        } else {
          setTimeout(checkStatus, 3000); // Retry after 3 seconds
        }
      } catch (err) {
        console.error("Error polling status:", err);
        setTimeout(checkStatus, 3000); // Retry even on error
      }
    }

    checkStatus(); // Start polling
  </script>
</body>
</html>
